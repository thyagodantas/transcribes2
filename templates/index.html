<script>
  document
    .getElementById("transcription-form")
    .addEventListener("submit", function (event) {
      event.preventDefault();
      var youtubeUrl = document.getElementById("youtube-url").value;

      // Mostrar o spinner de loading
      document.getElementById("progress-container").style.display = "block";
      document.getElementById("transcription-text").innerText = "";
      document.getElementById("transcription-result").style.display = "none"; // Esconder a transcrição

      // Etapa 1: Baixar o vídeo e iniciar a transcrição
      fetch("/baixar_video", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ youtube_url: youtubeUrl }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            throw new Error(data.error);
          }

          // Capturar o transcribe_id retornado
          var transcribeId = data.transcribe_id;

          // Conectar ao servidor para receber o progresso usando o transcribeId
          var eventSource = new EventSource(`/progress/${transcribeId}`);

          eventSource.onmessage = function (event) {
            var progressText = event.data;

            // Quando a transcrição for concluída
            if (progressText.startsWith("Transcrição finalizada")) {
              eventSource.close(); // Fechar a conexão SSE após a conclusão
              document.getElementById("progress-container").style.display =
                "none"; // Esconder o loading
              document.getElementById("transcription-result").style.display =
                "block"; // Exibir a transcrição

              // Simular a digitação da transcrição
              typeText(progressText.replace("Transcrição finalizada: ", ""));
            }
          };
        })
        .catch((error) => {
          document.getElementById("transcription-text").innerText =
            "Erro: " + error.message;
        });
    });

  // Função para simular a digitação
  function typeText(text) {
    let index = 0;
    const speed = 20; // Velocidade da digitação (ms)
    const transcriptionElement = document.getElementById("transcription-text");

    function type() {
      if (index < text.length) {
        transcriptionElement.innerHTML += text.charAt(index);
        index++;
        setTimeout(type, speed);
      }
    }

    type();
  }
</script>
